{% extends "base.html" %}
{% block title %}Inicio{% endblock %}
{% block header %}Panel General{% endblock %}

{% block content %}

<div class="grid md:grid-cols-3 gap-4 mb-6">

    <!-- Tarjeta 1 -->
    <div class="bg-white rounded-lg shadow p-4">
        <h6 class="text-sm text-gray-500">Total de registros</h6>
        <div class="text-2xl font-bold">{{ total_registros }}</div>
    </div>

    <!-- Tarjeta 2: Valor total -->
    <div class="bg-white rounded-lg shadow p-4">
        <h6 class="text-sm text-gray-500">Valor total</h6>
        <div class="text-2xl font-bold">{{ total_valor|floatformat:2 }}</div>
    </div>

    <!-- Tarjeta 3 -->
    <div class="bg-white rounded-lg shadow p-4">
        <h6 class="text-sm text-gray-500">Nuevas entradas</h6>
        <div class="text-2xl font-bold">{{ nuevas_entradas }}</div>
    </div>

</div>

<!-- Cartelito / descripción -->
<div class="flex items-center justify-between mb-4">
    <p class="text-gray-600">Evolución</p>
    <div class="flex items-center space-x-2">
        <button class="px-3 py-1 border rounded range-preset" data-range="7">Últimos 7 días</button>
        <button class="px-3 py-1 border rounded range-preset" data-range="30">Últimos 30 días</button>
        <button class="px-3 py-1 border rounded range-preset" data-range="month">Este mes</button>
        <button class="px-3 py-1 border rounded range-preset" data-range="year">Último año</button>
    </div>
    <div class="flex items-center space-x-2">
        <label class="text-sm">Granularidad:</label>
        <select id="granularity-select" class="border rounded px-2 py-1">
            <option value="daily" {% if granularity == 'daily' %}selected{% endif %}>Diario</option>
            <option value="weekly" {% if granularity == 'weekly' %}selected{% endif %}>Semanal</option>
            <option value="monthly" {% if granularity == 'monthly' %}selected{% endif %}>Mensual</option>
            <option value="yearly" {% if granularity == 'yearly' %}selected{% endif %}>Anual</option>
        </select>
        <!-- Category and metrics multi-select -->
        <label class="text-sm">Categoría:</label>
        <select id="category-select" class="border rounded px-2 py-1">
            <option value="">Todas</option>
            {% for c in categories %}
            <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
        </select>

        <label class="text-sm">Métricas:</label>
        <select id="metrics-select" multiple size="3" class="border rounded px-2 py-1">
            {% for m in metrics_for_category %}
            <option value="{{ m.id }}" {% if metric_for_chart and m.id == metric_for_chart.id %}selected{% endif %}>{{ m.name }}</option>
            {% endfor %}
        </select>

        <input type="date" id="from-date" value="{{ range_from }}" class="border rounded px-2 py-1" />
        <input type="date" id="to-date" value="{{ range_to }}" class="border rounded px-2 py-1" />
        <button id="apply-range" class="bg-blue-600 text-white px-3 py-1 rounded">Aplicar</button>
    </div>
</div>

<!-- Card del gráfico -->
<div class="bg-white rounded-lg shadow p-4">
    <div id="chart"></div>
    <p class="text-xs text-gray-500 mt-2">Fechas interpretadas en zona horaria del servidor.</p>
</div>

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    // Datos enviados desde Django (seguro: listas)
    const labels = {{ chart_labels|safe }};
    const values = {{ chart_values|safe }};

    // Configuración del gráfico

    const options = {
        chart: {
            type: 'area',
            height: 320,
            toolbar: { show: false },
            zoom: { enabled: false }
        },
        series: [{
            name: 'Registros',
            data: values
        }],
        xaxis: {
            categories: labels,
            labels: { rotate: -45 }
        },
        stroke: { curve: 'smooth', width: 2 },
        fill: {
            type: 'gradient',
            gradient: { shadeIntensity: 0.4, opacityFrom: 0.6, opacityTo: 0.1 }
        },
        tooltip: {
            x: { format: 'dd/MM' }
        },
        grid: { borderColor: '#e6e6e6' },
        colors: ['#2563eb']  // azul (Tailwind blue-600)
    };

    const chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();
    // expose chart to global for dashboard-range.js
    window.dashboardChart = chart;
</script>

<!-- range JS -->
<script src="{{ STATIC_URL }}js/dashboard-range.js"></script>

{% endblock %}
